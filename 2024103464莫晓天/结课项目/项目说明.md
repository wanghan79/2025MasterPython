# 项目概述：

基于U-Net扩散模型的图像修复系统
本项目实现了一套图像修复系统，其核心在于利用扩散模型的去噪能力，实现对图像中缺失或被遮挡区域的无缝填充与重建。

# 项目目标:

1. 实现鲁棒的图像修复方案： 精确地重建图像缺失部分，确保修复结果在视觉连贯性和内容合理性上达到高标准。

2. 构建基于扩散模型的架构： 采用U-Net网络作为扩散框架中的核心噪声预测组件。

3. 支持多样化遮罩处理： 系统需有效应对多种形态和大小的遮罩区域，涵盖随机区块、中心区域、不规则形状以及条纹遮挡等典型场景。

4. 提供完整的模型训练能力： 支持在用户自定义数据集上训练U-Net模型，以优化特定场景下的修复性能。

# 主要思路

系统架构包含三个核心模块：实用工具函数、U-Net模型定义与扩散过程实现。

## 实用工具函数

该模块负责基础的图像与遮罩处理操作。

图像与遮罩加载 (load_image, load_mask)： 负责读取图像文件与遮罩文件，执行必要的预处理（如尺寸调整、格式转换为PyTorch张量）。load_mask函数特别引入了高斯模糊处理，以柔化遮罩边缘，促进修复过程中生成更自然的过渡区域。

图像保存 (save_tensor_as_image)： 用于将处理后的PyTorch张量结果保存为标准图像文件，便于结果可视化和持久化存储。

高级遮罩生成 (create_advanced_mask)： 核心功能是动态创建多种预设模式的遮罩（随机矩形、中心块、不规则形态、条纹）。此功能对于训练阶段至关重要，它使得模型无需依赖外部预定义遮罩即可学习应对广泛的修复场景。

## U-Net模型

UNet 类是本系统的核心模型，作为一个专为图像到图像转换设计的卷积神经网络，其在扩散过程中承担噪声预测的关键角色。

编码器-解码器架构： 遵循经典的U-Net设计范式，包含用于捕获高层语义和上下文信息的收缩路径（编码器），以及实现精确定位和细节重建的扩展路径（解码器）。

跳跃连接： 这是U-Net的核心特性，通过将编码器各层输出的特征图与解码器对应层的特征图进行拼接，有效保留了低层细节信息，显著提升了上采样重建的质量。

时间步长嵌入： 为适应扩散模型中噪声水平随时间步长变化的特性，模型引入了时间嵌入机制。当前时间步长信息通过 sinusoidal_embedding 进行编码，并经由 time_mlp 层注入到U-Net的多个层级中。这使得模型能够根据当前去噪阶段动态调整其预测行为，显著提升了去噪过程的有效性。

## 扩散过程

Diffusion 类封装了扩散模型的核心过程，包括前向扩散（加噪）和反向扩散（去噪/修复）。

噪声调度： 定义了方差调度参数 (betas)，用于精确控制每一步添加的噪声量。基于 betas 派生出关键参数 alphas 及其累积乘积 alpha_bars，这些参数是计算任意时间步长噪声水平的基础。

前向扩散 (add_noise)： 此方法接收原始图像 (x0) 和指定时间步长 (t)，依据噪声调度添加可控的高斯噪声，生成对应的噪声图像 (xt)。该过程主要用于模型训练阶段的数据模拟。

反向扩散/去噪 (denoise_step)： 这是图像修复的核心环节。给定噪声图像 (xt)，U-Net模型预测其中添加的噪声分量。结合模型预测和预计算的扩散参数，denoise_step 方法重构出噪声水平更低的图像 (xt_prev)。

修复过程的关键集成： 在反向扩散的每一步中，系统严格确保仅对被遮罩区域进行重建。原始图像中未被遮罩的已知区域在每个时间步都被直接保留并整合回 xt_prev。这一机制保证了图像的有效信息部分在修复过程中保持不变，仅缺失区域由扩散模型逐步生成填充。此外，在反向过程的最终步骤，模型会直接预测原始图像 (x0) 以促进更好的收敛效果。

## 训练与推理流程

数据准备 (InpaintingDataset)： 此类负责从指定目录加载训练图像，并在训练过程中动态生成随机遮罩。此设计使模型能够广泛学习修复各种形态的缺失区域。

模型训练 (train_model)： 此函数管理训练循环。在迭代训练周期时，向训练图像添加噪声，输入U-Net模型进行噪声预测，并计算预测噪声与真实噪声在遮罩区域上的均方误差 (MSE) 作为损失函数。训练过程采用Adam优化器，并配合学习率调度策略。

修复推理 (inpainting)： 此函数执行实际的修复任务。它加载输入图像及其遮罩，初始化训练好的U-Net模型（或随机初始化），然后从最大噪声状态开始，按时间步长反向迭代应用 denoise_step 函数，逐步重建被遮罩区域。可选项支持保存中间结果以可视化修复进程。
